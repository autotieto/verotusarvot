name: Site

on: workflow_dispatch

jobs:

  build:
    runs-on: ubuntu-latest

    steps:

    - name: git checkout
      uses: actions/checkout@v4

    - name: Install uv
      uses: astral-sh/setup-uv@v6

    - name: Set up Python
      run: uv python install
      
    - name: Build
      run: |
        echo "Deleting ./site and ./data"
        rm -rf ./site ./data
        echo "Creating ./site and ./data"
        mkdir -p ./site ./data
        echo "Downloading data..."
        uv run 01_download_data.py
        echo "Processing data..."
        uv run 02_process_data.py

    - name: Archive production artifacts
      uses: actions/upload-artifact@v4
      with:
        name: site
        path: site

    - name: Upload static files as artifact
      id: deployment
      uses: actions/upload-pages-artifact@v3
      with:
        path: ./site

  deploy:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      pages: write      # to deploy to Pages
      id-token: write   # to verify the deployment originates from an appropriate source
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4        